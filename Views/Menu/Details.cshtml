@model QuanVitLonManager.Models.MenuItem

@{
    ViewData["Title"] = Model.Name;
}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-5">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="@Model.Name" class="img-fluid rounded product-detail-img">
            }
            else
            {
                <img src="/images/default-food.jpg" alt="@Model.Name" class="img-fluid rounded product-detail-img">
            }
        </div>
        <div class="col-md-7">
            <h1 class="mb-3">@Model.Name</h1>
            
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <p class="lead mb-4">@Model.Description</p>
            }
            
            <div class="mb-4">
                @if (Model.DiscountPercentage > 0)
                {
                    <span class="h4 text-danger me-2">@Model.Price.ToString("N0") đ</span>
                    <span class="text-decoration-line-through text-muted">@Model.OriginalPrice.ToString("N0") đ</span>
                    <span class="badge bg-danger ms-2">-@Model.DiscountPercentage%</span>
                }
                else
                {
                    <span class="h4">@Model.Price.ToString("N0") đ</span>
                }
            </div>
            
            @if (!string.IsNullOrEmpty(Model.DetailedDescription))
            {
                <div class="mb-4">
                    <h5>Mô tả chi tiết</h5>
                    <p>@Model.DetailedDescription</p>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(Model.Ingredients))
            {
                <div class="mb-4">
                    <h5>Nguyên liệu</h5>
                    <p>@Model.Ingredients</p>
                </div>
            }
            
            <div class="d-flex align-items-center mb-4">
                <div class="input-group me-3" style="width: 130px;">
                    <button class="btn btn-outline-secondary" type="button" id="decreaseQuantity">-</button>
                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1">
                    <button class="btn btn-outline-secondary" type="button" id="increaseQuantity">+</button>
                </div>
                <button class="btn btn-primary" id="addToCart" data-item-id="@Model.Id">
                    <i class="fas fa-cart-plus me-2"></i>Thêm vào giỏ hàng
                </button>
            </div>
            
            <div class="mt-4">
                <a href="javascript:history.back()" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
            </div>
        </div>
    </div>
    
    @if (Model.Reviews != null && Model.Reviews.Any())
    {
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Đánh giá (@Model.Reviews.Count)</h3>
                @foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">@review.User?.UserName</h5>
                                <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                            </div>
                            <div class="mb-2">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= review.Rating)
                                    {
                                        <i class="fas fa-star text-warning"></i>
                                    }
                                    else
                                    {
                                        <i class="far fa-star text-warning"></i>
                                    }
                                }
                            </div>
                            <p class="card-text">@review.Comment</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    
    @if (ViewBag.RelatedItems != null && ViewBag.RelatedItems.Count > 0)
    {
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Các món liên quan</h3>
                <div class="row">
                    @foreach (var item in ViewBag.RelatedItems)
                    {
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                {
                                    <img src="@item.ImageUrl" class="card-img-top" alt="@item.Name" style="height: 180px; object-fit: cover;">
                                }
                                else
                                {
                                    <img src="/images/default-food.jpg" class="card-img-top" alt="@item.Name" style="height: 180px; object-fit: cover;">
                                }
                                <div class="card-body">
                                    <h5 class="card-title">@item.Name</h5>
                                    <p class="card-text text-truncate">@item.Description</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">@item.Price.ToString("N0") đ</span>
                                        <a href="@Url.Action("Details", new { id = item.Id })" class="btn btn-sm btn-outline-primary">Chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $("#decreaseQuantity").click(function() {
                var quantity = parseInt($("#quantity").val());
                if (quantity > 1) {
                    $("#quantity").val(quantity - 1);
                }
            });
            
            $("#increaseQuantity").click(function() {
                var quantity = parseInt($("#quantity").val());
                $("#quantity").val(quantity + 1);
            });
            
            $("#addToCart").click(function() {
                var itemId = $(this).data("item-id");
                var quantity = parseInt($("#quantity").val());
                
                $.ajax({
                    url: "/Cart/AddToCart",
                    type: "POST",
                    data: {
                        itemId: itemId,
                        quantity: quantity
                    },
                    success: function(response) {
                        if (response.success) {
                            toastr.success('Đã thêm vào giỏ hàng!');
                            // Cập nhật số lượng giỏ hàng trên thanh điều hướng
                            if (response.cartItemCount) {
                                $(".cart-count").text(response.cartItemCount);
                            }
                        } else {
                            toastr.error(response.message || 'Có lỗi xảy ra!');
                        }
                    },
                    error: function() {
                        toastr.error('Có lỗi xảy ra khi thêm vào giỏ hàng!');
                    }
                });
            });
        });
    </script>
}